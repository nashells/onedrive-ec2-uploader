# AWS EC2からOneDriveファイル作成アプリケーション要求仕様書

## 1. プロジェクト概要

### 1.1 目的
AWS EC2インスタンスから個人用Microsoft OneDriveストレージにファイルを自動的に作成・アップロードする仕組みの動作原理を検証するためのプロトタイプアプリケーションを開発する。

### 1.2 背景
- クラウドサービス間でのデータ連携の需要増加
- EC2上で処理したデータを個人用クラウドストレージに保存したいニーズ
- OneDrive APIの動作検証

### 1.3 スコープ
- AWS EC2からOneDriveへのファイルアップロード機能の実装
- 認証・認可フローの実装
- 基本的なエラーハンドリング
- 動作確認用のシンプルなUI（オプション）

## 2. 機能要求

### 2.1 必須機能

#### 2.1.1 認証機能
- Microsoft Graph APIを使用したOAuth 2.0認証
- リフレッシュトークンによる自動トークン更新
- 認証情報の安全な保存

#### 2.1.2 ファイルアップロード機能
- テキストファイルの作成とアップロード
- バイナリファイルのアップロード
- ファイルサイズ制限の確認（OneDrive APIの制限に準拠）
- アップロード進捗の追跡

#### 2.1.3 ファイル管理機能
- OneDrive上のディレクトリ構造の作成
- ファイルの上書き/新規作成の選択
- アップロード済みファイルの一覧取得

#### 2.1.4 ログ機能
- 操作ログの記録
- エラーログの記録
- アップロード履歴の保存

### 2.2 オプション機能（今回は実装しない）

- スケジューリング機能
- 通知機能
- Web UI

## 3. 非機能要求

### 3.1 パフォーマンス
- 100MBまでのファイルを5分以内にアップロード
- 同時アップロード数: 最大5ファイル
- API呼び出しレート制限への対応

### 3.2 セキュリティ
- 認証情報の暗号化保存
- HTTPS通信の使用
- IAMロールによるEC2インスタンスの権限管理
- シークレット管理（AWS Secrets Manager推奨）

### 3.3 可用性
- エラー時の自動リトライ（最大3回）
- ネットワーク障害時の適切なエラーハンドリング
- 部分的なアップロード失敗時の再開機能

### 3.4 保守性
- 最小限のデバッグログの出力

### 3.5 移植性
- 環境変数による設定管理

## 4. システム構成

### 4.1 技術スタック
- **プログラミング言語**: Python 3.9+
- **フレームワーク**: FastAPI
- **認証ライブラリ**: MSAL (Microsoft Authentication Library) for Python
- **AWS SDK**: boto3
- **HTTPライブラリ**: requests, aiohttp
- **データベース**: SQLite（ローカル）またはDynamoDB（プロダクション）
- **その他の主要ライブラリ**:
  - `python-dotenv`: 環境変数管理
  - `uvicorn`: ASGIサーバー（FastAPIを使う場合）

### 4.2 外部依存関係
- Microsoft Graph API
- OneDrive API
- AWS EC2
- AWS Secrets Manager（オプション）
- AWS CloudWatch（ログ収集）

### 4.3 アーキテクチャ
```
┌─────────────────┐
│   AWS EC2       │
│                 │
│ ┌─────────────┐ │     HTTPS      ┌──────────────────┐
│ │Application  │ ├───────────────►│ Microsoft Graph  │
│ │             │ │                 │ API / OneDrive   │
│ └─────────────┘ │                 └──────────────────┘
│                 │
│ ┌─────────────┐ │
│ │ Secrets     │ │
│ │ Manager     │ │
│ └─────────────┘ │
└─────────────────┘
```

## 5. 開発フェーズ

### Phase 1: 基本機能実装（3-5日）
- Python開発環境構築
- OAuth認証フローの実装
- 単一ファイルアップロード機能の動作確認

### Phase 2: 最小限の調整（1-2日）
- 基本的なエラーハンドリング
- 動作確認用スクリプトの作成

## 6. 制約事項

### 6.1 技術的制約
- OneDrive API の呼び出しレート制限
- ファイルサイズ制限（単一ファイル最大250GB）
- EC2インスタンスのストレージ容量

### 6.2 運用制約
- 個人用OneDriveアカウントが必要
- Microsoft Azureアプリケーション登録が必要
- EC2インスタンスの継続的な稼働コスト

## 7. 成功基準

### 7.1 機能面
- EC2からOneDriveへのファイルアップロードが動作すること
- 認証フローが動作すること

### 7.2 品質面
- 動作確認用のため、テストやコード品質は不問
- 最小限の動作説明書があること

## 8. リスクと対策

### 8.1 技術的リスク
- **リスク**: API変更による互換性問題
- **対策**: APIバージョンの固定、定期的な動作確認

### 8.2 セキュリティリスク
- **リスク**: 認証情報の漏洩
- **対策**: 暗号化、アクセス制限、定期的な認証情報のローテーション

### 8.3 運用リスク
- **リスク**: EC2インスタンスの障害
- **対策**: CloudWatchによる監視、自動復旧設定

## 9. 今後の拡張可能性

- Google Drive、Dropboxなど他のクラウドストレージ対応
- S3からOneDriveへの自動同期
- Lambda関数による実装
- マルチテナント対応
- 企業向けOneDrive for Business対応

## 10. 用語定義

- **OneDrive**: Microsoft提供のクラウドストレージサービス
- **Microsoft Graph API**: Microsoft 365サービスにアクセスするための統一API
- **OAuth 2.0**: 認可フレームワーク
- **リフレッシュトークン**: アクセストークンを更新するためのトークン
- **EC2**: Amazon Elastic Compute Cloud